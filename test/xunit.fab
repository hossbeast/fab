/* Copyright (c) 2012-2015 Todd Freed <todd.freed@gmail.com>

   This file is part of fab.
   
   fab is free software: you can redistribute it and/or modify
   it under the terms of the GNU General Public License as published by
   the Free Software Foundation, either version 3 of the License, or
   (at your option) any later version.
   
   fab is distributed in the hope that it will be useful,
   but WITHOUT ANY WARRANTY; without even the implied warranty of
   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
   GNU General Public License for more details.
   
   You should have received a copy of the GNU General Public License
   along with fab.  If not, see <http://www.gnu.org/licenses/>. */

# @fab.xunit
#  locates unit directories in $dunits
#  fabricates xunit sos per unit
#  provides @test task to execute all xunit tests
#
# var/closure
#  cc         - compiler for xunit sos
#  cflags     - compiler flags for xunit sos
#
#  dirs       - directories containing .c files
#  rdirs      - directories containing .c files, recursive search
#  filter     - filter for unit directories
#
#  dunits     - unit directories
#  xunit_sos  - xunit sos

# definitions
+[ $*/../vars.fab ]

# filter for unit directories
$filter = [ ]

# unit directories
$dunits = [
	[
    $dirs							# directories
    [ $rdirs ~ lsr ]	# recursive directories
    ~ [ $filter ]
	]

 # those directories that contain an eponymous c file and a test.c
 ~ ?, -d s,$,/test.c -f dn s,\x5b^/\x5d+$,\0/\0.c -f dn 
]

$xunit_sos = [ $dunits ~ ?, s,\x5b^/\x5d+$,\0/\0.xapi.xunit.so ]

# test sos compiled for xunit ; the unit so includes the source and test object files and their dependencies
[ $xunit_sos ~ dj shift ]
	:: [[ $< ~ ?, dn s,\x5b^/\x5d+$,\0/\0.xapi.xunit.pic.o ]
			[ $< ~ ?, dn s,\x5b^/\x5d+$,\0/test.xapi.xunit.pic.o ]]
{
	[ $cc ] [ $cflags -shared ~ uu fi ] -o [ $@ ] [
	] [ [ $@ ~ rx/aneedw lx/o fi ] ~ s/^/\x20\x5c\x0a ]
}

#
# individual test tasks
#  its not really possible to write this with the current fabfile syntax because you go
#  from dunits -> @test.<name> but on the RHS you cant recover the original entry from dunits
# [ $dunits ~ ?, s,$,\x5b^/\x5d+$,/../test/\0 ] ::
#

# run all tests
[ @test ] : [ $dunits ~ ?, s,\x5b^/\x5d+$,\0/\0.xapi.xunit.so ]
{
	[ $xunit_valgrind_runner ] [ $xunit_xapi_devel ] [ $@ ~ rx/aneed lx/so fi ] 1>&501 2>&502
}

[ @test.verbose ] : [ $dunits ~ ?, s,\x5b^/\x5d+$,\0/\0.xapi.xunit.so ]
{
	[ $xunit_valgrind_runner ] [ $xunit_xapi_devel ] +XUNIT [ $@ ~ rx/aneed lx/so fi ] 1>&501 2>&502
}
